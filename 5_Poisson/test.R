Script started on Mon 20 Nov 2023 16:20:22 AEDT
]0;babv971@niasra-hpc:~/R-VGAL/5_Poisson[?1034h[babv971@niasra-hpc 5_Poisson]$ cat test.R
print("Hello")]0;babv971@niasra-hpc:~/R-VGAL/5_Poisson[babv971@niasra-hpc 5_Poisson]$ Rsrip[K[K[K[Kcript[K[K[K[K[Kscript test.R
bash: Rscript: command not found...
Similar command is: 'script'
]0;babv971@niasra-hpc:~/R-VGAL/5_Poisson[babv971@niasra-hpc 5_Poisson]$ car[K[K[Kcat test.R
print("Hello")]0;babv971@niasra-hpc:~/R-VGAL/5_Poisson[babv971@niasra-hpc 5_Poisson]$ script R[Ktest.R[K[K[K[K[K[K[K[K[K[K[K[K[Kscript tets.R
Script started, file is tets.R
]0;babv971@niasra-hpc:~/R-VGAL/5_Poisson[?1034h[babv971@niasra-hpc 5_Poisson]$ R < poisson_mm_main.R --no-save[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[KR --version
bash: R: command not found...
]0;babv971@niasra-hpc:~/R-VGAL/5_Poisson[babv971@niasra-hpc 5_Poisson]$ which Rscript
/usr/bin/which: no Rscript in (/usr/condabin:/usr/local/bin:/usr/bin:/usr/local/sbin:/usr/sbin:/usr/local/go/bin:/usr/local/sbin:/usr/local/bin:/home/babv971/.local/bin:/home/babv971/bin:/usr/local/go/bin:/usr/local/sbin:/usr/local/bin:/usr/local/go/bin:/usr/local/sbin:/usr/local/bin:/usr/local/go/bin:/usr/local/sbin:/usr/local/bin:/usr/local/go/bin:/usr/local/sbin:/usr/local/bin)
]0;babv971@niasra-hpc:~/R-VGAL/5_Poisson[babv971@niasra-hpc 5_Poisson]$ cd gome[K[K[K[K~/
]0;babv971@niasra-hpc:~[babv971@niasra-hpc ~]$ pwd
/home/babv971
]0;babv971@niasra-hpc:~[babv971@niasra-hpc ~]$ ls
[0m[38;5;27mKAUST[0m  [48;5;10;38;5;21mR[0m  [38;5;27mr4ds[0m  [38;5;27mR-VGAL[0m  [38;5;27mR-VGA-Whittle[0m  [38;5;27mSSA_backup[0m  [48;5;10;38;5;21mSSA_model[0m  [38;5;27mSTAT301_2022[0m  [48;5;10;38;5;21mSTAT902[0m  [38;5;27mSummer_project_2021[0m
]0;babv971@niasra-hpc:~[babv971@niasra-hpc ~]$ cd R
]0;babv971@niasra-hpc:~/R[babv971@niasra-hpc R]$ ls
[0m[48;5;10;38;5;21mx86_64-redhat-linux-gnu-library[0m
]0;babv971@niasra-hpc:~/R[babv971@niasra-hpc R]$ cd x86_64-redhat-linux-gnu-library/
]0;babv971@niasra-hpc:~/R/x86_64-redhat-linux-gnu-library[babv971@niasra-hpc x86_64-redhat-linux-gnu-library]$ ls
[0m[48;5;10;38;5;21m3.6[0m  [48;5;10;38;5;21m4.0[0m  [38;5;27m4.1[0m
]0;babv971@niasra-hpc:~/R/x86_64-redhat-linux-gnu-library[babv971@niasra-hpc x86_64-redhat-linux-gnu-library]$ cd 4.1
]0;babv971@niasra-hpc:~/R/x86_64-redhat-linux-gnu-library/4.1[babv971@niasra-hpc 4.1]$ ls
[0m[38;5;27mabind[0m          [38;5;27mcellranger[0m  [38;5;27mdeldir[0m          [38;5;27mfds[0m          [38;5;27mgooglesheets4[0m  [38;5;27misoband[0m       [38;5;27mMatrix[0m        [38;5;27mpcaPP[0m        [38;5;27mps[0m             [38;5;27mreadxl[0m       [38;5;27mscales[0m       [38;5;27mtextshaping[0m      [38;5;27muuid[0m
[38;5;27mAER[0m            [38;5;27mcheckmate[0m   [38;5;27mDeriv[0m           [38;5;27mfields[0m       [38;5;27mGpGp[0m           [38;5;27mjpeg[0m          [38;5;27mmatrixcalc[0m    [38;5;27mpillar[0m       [38;5;27mpurrr[0m          [38;5;27mrematch[0m      [38;5;27mselectr[0m      [38;5;27mtfautograph[0m      [38;5;27mvctrs[0m
[38;5;27malabama[0m        [38;5;27mclassInt[0m    [38;5;27mdesc[0m            [38;5;27mFNN[0m          [38;5;27mGPvecchia[0m      [38;5;27mjsonlite[0m      [38;5;27mMatrixModels[0m  [38;5;27mpkgbuild[0m     [38;5;27mqlcMatrix[0m      [38;5;27mrematch2[0m     [38;5;27msf[0m           [38;5;27mtfruns[0m           [38;5;27mviridis[0m
[38;5;27maplore3[0m        [38;5;27mcli[0m         [38;5;27mdeSolve[0m         [38;5;27mforcats[0m      [38;5;27mgridExtra[0m      [38;5;27mkeras[0m         [38;5;27mmatrixStats[0m   [38;5;27mpkgconfig[0m    [38;5;27mquadprog[0m       [38;5;27mreprex[0m       [38;5;27mslam[0m         [38;5;27mtibble[0m           [38;5;27mviridisLite[0m
[38;5;27mash[0m            [38;5;27mclipr[0m       [38;5;27mdiffobj[0m         [38;5;27mforecast[0m     [38;5;27mgtable[0m         [38;5;27mkernlab[0m       [38;5;27mmclust[0m        [38;5;27mpkgload[0m      [38;5;27mquantmod[0m       [38;5;27mreshape2[0m     [38;5;27msp[0m           [38;5;27mtidyr[0m            [38;5;27mvroom[0m
[38;5;27mastsa[0m          [38;5;27mcmdstanr[0m    [38;5;27mdistributional[0m  [38;5;27mFormula[0m      [38;5;27mhaven[0m          [38;5;27mks[0m            [38;5;27mmemoise[0m       [38;5;27mplot3D[0m       [38;5;27mquantreg[0m       [38;5;27mreticulate[0m   [38;5;27mspacetime[0m    [38;5;27mtidyselect[0m       [38;5;27mwaldo[0m
[38;5;27mbackports[0m      [38;5;27mcoda[0m        [38;5;27mdocopt[0m          [38;5;27mfracdiff[0m     [38;5;27mhdrcde[0m         [38;5;27mlabeling[0m      [38;5;27mminqa[0m         [38;5;27mplyr[0m         [38;5;27mragg[0m           [38;5;27mrlang[0m        [38;5;27mspam[0m         [38;5;27mtidyverse[0m        [38;5;27mwhisker[0m
[38;5;27mbeyondWhittle[0m  [38;5;27mcolorspace[0m  [38;5;27mdotCall64[0m       [38;5;27mFRK[0m          [38;5;27mhere[0m           [38;5;27mlatticeExtra[0m  [38;5;27mmisc3d[0m        [38;5;27mpng[0m          [38;5;27mrainbow[0m        [38;5;27mR.methodsS3[0m  [38;5;27msparseinv[0m    [38;5;27mtimechange[0m       [38;5;27mwithr[0m
[38;5;27mBH[0m             [38;5;27mconfig[0m      [38;5;27mdplyr[0m           [38;5;27mgargle[0m       [38;5;27mHmisc[0m          [38;5;27mlifecycle[0m     [38;5;27mmodelr[0m        [38;5;27mpolynom[0m      [38;5;27mrandtoolbox[0m    [38;5;27mrngWELL[0m      [38;5;27mSparseM[0m      [38;5;27mtimeDate[0m         [38;5;27mwk[0m
[38;5;27mbit[0m            [38;5;27mconflicted[0m  [38;5;27mdtplyr[0m          [38;5;27mgenerics[0m     [38;5;27mhms[0m            [38;5;27mlme4[0m          [38;5;27mmulticool[0m     [38;5;27mpomp[0m         [38;5;27mrbibutils[0m      [38;5;27mR.oo[0m         [38;5;27msparsesvd[0m    [38;5;27mTMB[0m              [38;5;27mxts[0m
[38;5;27mbit64[0m          [38;5;27mcorrplot[0m    [38;5;27me1071[0m           [38;5;27mggmatplot[0m    [38;5;27mhtmlTable[0m      [38;5;27mlmtest[0m        [38;5;27mmunsell[0m       [38;5;27mposterior[0m    [38;5;27mRColorBrewer[0m   [38;5;27mrprojroot[0m    [38;5;27mStanHeaders[0m  [38;5;27mtmvtnorm[0m         [38;5;27mzeallot[0m
[38;5;27mbitops[0m         [38;5;27mcowplot[0m     [38;5;27mellipse[0m         [38;5;27mggplot2[0m      [38;5;27mhtmlwidgets[0m    [38;5;27mlocfit[0m        [38;5;27mmvnfast[0m       [38;5;27mpracma[0m       [38;5;27mRcppArmadillo[0m  [38;5;27mrstan[0m        [38;5;27mstatmod[0m      [38;5;27mTruncatedNormal[0m  [38;5;27mzoo[0m
[38;5;27mblob[0m           [38;5;27mcpp11[0m       [38;5;27mellipsis[0m        [38;5;27mggpubr[0m       [38;5;27mhttr[0m           [38;5;27mloo[0m           [38;5;27mmvtnorm[0m       [38;5;27mpraise[0m       [38;5;27mRcppEigen[0m      [38;5;27mrstatix[0m      [38;5;27mstcos[0m        [38;5;27mtseries[0m
[38;5;27mbrio[0m           [38;5;27mcrayon[0m      [38;5;27mexpm[0m            [38;5;27mggrepel[0m      [38;5;27mids[0m            [38;5;27mLSTS[0m          [38;5;27mnleqslv[0m       [38;5;27mprettyunits[0m  [38;5;27mRcppParallel[0m   [38;5;27mrstudioapi[0m   [38;5;27mstringr[0m      [38;5;27mTTR[0m
[38;5;27mbroom[0m          [38;5;27mcurl[0m        [38;5;27mfansi[0m           [38;5;27mggsci[0m        [38;5;27minline[0m         [38;5;27mltsa[0m          [38;5;27mnloptr[0m        [38;5;27mprocessx[0m     [38;5;27mRcppTOML[0m       [38;5;27mR.utils[0m      [38;5;27msystemfonts[0m  [38;5;27mtzdb[0m
[38;5;27mcallr[0m          [38;5;27mdata.table[0m  [38;5;27mfarver[0m          [38;5;27mggsignif[0m     [38;5;27minterp[0m         [38;5;27mlubridate[0m     [38;5;27mnumDeriv[0m      [38;5;27mprofvis[0m      [38;5;27mRCurl[0m          [38;5;27mrvest[0m        [38;5;2ellipsis[0m        [38;5;27mggpubr[0m       [38;5;27mhttr[0m           [38;5;27mloo[0m           [38;5;27mmvtnorm[0m       [38;5;27mpraise[0m       [38;5;27mRcppEigen[0m      [38;5;27mrstatix[0m      [38;5;27mstcos[0m        [38;5;27mtseries[0m
[38;5;27mbrio[0m           [38;5;27mcrayon[0m      [38;5;27mexpm[0m            [38;5;27mggrepel[0m      [38;5;27mids[0m            [38;5;27mLSTS[0m          [38;5;27mnleqslv[0m       [38;5;27mprettyunits[0m  [38;5;27mRcppParallel[0m   [38;5;27mrstudioapi[0m   [38;5;27mstringr[0m      [38;5;27mTTR[0m
[38;5;27mbroom[0m          [38;5;27mcurl[0m        [38;5;27mfansi[0m           [38;5;27mggsci[0m        [38;5;27minline[0m         [38;5;27mltsa[0m          [38;5;27mnloptr[0m        [38;5;27mprocessx[0m     [38;5;27mRcppTOML[0m       [38;5;27mR.utils[0m      [38;5;27msystemfonts[0m  [38;5;27mtzdb[0m
[38;5;27mcallr[0m          [38;5;27mdata.table[0m  [38;5;27mfarver[0m          [38;5;27mggsignif[0m     [38;5;27minterp[0m         [38;5;27mlubridate[0m     [38;5;27mnumDeriv[0m      [38;5;27mprofvis[0m      [38;5;27mRCurl[0m          [38;5;27mrvest[0m        [38;5;27mtensorA[0m      [38;5;27munits[0m
[38;5;27mcar[0m            [38;5;27mDBI[0m         [38;5;27mfastmatrix[0m      [38;5;27mgmm[0m          [38;5;27mintervals[0m      [38;5;27mmaps[0m          [38;5;27mpatchwork[0m     [38;5;27mprogress[0m     [38;5;27mRdpack[0m         [38;5;27ms2[0m           [38;5;27mtensorflow[0m   [38;5;27murca[0m
[38;5;27mcarData[0m        [38;5;27mdbplyr[0m      [38;5;27mfda[0m             [38;5;27mgoogledrive[0m  [38;5;27minvgamma[0m       [38;5;27mmaptools[0m      [38;5;27mpbkrtest[0m      [38;5;27mproxy[0m        [38;5;27mreadr[0m          [38;5;27msandwich[0m     [38;5;27mtestthat[0m     [38;5;27mutf8[0m
]0;babv971@niasra-hpc:~/R/x86_64-redhat-linux-gnu-library/4.1[babv971@niasra-hpc 4.1]$ cd bin
bash: cd: bin: No such file or directory
]0;babv971@niasra-hpc:~/R/x86_64-redhat-linux-gnu-library/4.1[babv971@niasra-hpc 4.1]$ cd ~/
]0;babv971@niasra-hpc:~[babv971@niasra-hpc ~]$ hm[K[Kls
[0m[38;5;27mKAUST[0m  [48;5;10;38;5;21mR[0m  [38;5;27mr4ds[0m  [38;5;27mR-VGAL[0m  [38;5;27mR-VGA-Whittle[0m  [38;5;27mSSA_backup[0m  [48;5;10;38;5;21mSSA_model[0m  [38;5;27mSTAT301_2022[0m  [48;5;10;38;5;21mSTAT902[0m  [38;5;27mSummer_project_2021[0m
]0;babv971@niasra-hpc:~[babv971@niasra-hpc ~]$ cd R
]0;babv971@niasra-hpc:~/R[babv971@niasra-hpc R]$ cd[K[Kls
[0m[48;5;10;38;5;21mx86_64-redhat-linux-gnu-library[0m
]0;babv971@niasra-hpc:~/R[babv971@niasra-hpc R]$ lscd R[2Pls[Kssh nas[K[Kiasra-node3
The authenticity of host 'niasra-node3 (10.0.0.4)' can't be established.
RSA key fingerprint is SHA256:fQlB9Dg+vYfRYa56zPv8kV45nz1kY9cCfk7XTkw35Y8.
RSA key fingerprint is MD5:6d:f2:bf:93:06:b9:01:65:42:f6:f6:40:32:4e:e6:9e.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added 'niasra-node3,10.0.0.4' (RSA) to the list of known hosts.
babv971@niasra-node3's password: 
Last login: Thu Mar  2 11:15:14 2023
]0;babv971@niasra-node3:~[?2004h[babv971@niasra-node3 ~]$ Rscript test.R
[?2004lFatal error: cannot open file 'test.R': No such file or directory
]0;babv971@niasra-node3:~[?2004h[babv971@niasra-node3 ~]$ ls[K[Kpwd
[?2004l/home/babv971
]0;babv971@niasra-node3:~[?2004h[babv971@niasra-node3 ~]$ cs[Kd ~/R-VGA:/[K[KL/%[K5_Poisson
[?2004l]0;babv971@niasra-node3:~/R-VGAL/5_Poisson[?2004h[babv971@niasra-node3 5_Poisson]$ ls
[?2004l[0m[01;34mdata[0m  [01;34mmulti_sims[0m  [01;34mplots[0m  poisson_mm_main.R  poisson_multi_sims.R  [01;34mresults[0m  Rplots.pdf  [01;34msource[0m  test.R  tets.R
]0;babv971@niasra-node3:~/R-VGAL/5_Poisson[?2004h[babv971@niasra-node3 5_Poisson]$ Rscript test.R
[?2004lError: unexpected symbol in "Script started"
Execution halted
]0;babv971@niasra-node3:~/R-VGAL/5_Poisson[?2004h[babv971@niasra-node3 5_Poisson]$ RScript test.R[K[K[K[K[K[K[K[K[K[K[K[K[K[Kcat R[K[K test.R
[?2004lScript started on Mon 20 Nov 2023 16:20:22 AEDT
]0;babv971@niasra-hpc:~/R-VGAL/5_Poisson[?1034h[babv971@niasra-hpc 5_Poisson]$ cat test.R
print("Hello")]0;babv971@niasra-hpc:~/R-VGAL/5_Poisson[babv971@niasra-hpc 5_Poisson]$ Rsrip[K[K[K[Kcript[K[K[K[K[Kscript test.R
bash: Rscript: command not found...
Similar command is: 'script'
]0;babv971@niasra-hpc:~/R-VGAL/5_Poisson[babv971@niasra-hpc 5_Poisson]$ car[K[K[Kcat test.R
print("Hello")]0;babv971@niasra-hpc:~/R-VGAL/5_Poisson[babv971@niasra-hpc 5_Poisson]$ script R[Ktest.R[K[K[K[K[K[K[K[K[K[K[K[K[Kscript tets.R
Script started, file is tets.R
]0;babv971@niasra-hpc:~/R-VGAL/5_Poisson[?1034h[babv971@niasra-hpc 5_Poisson]$ R < poisson_mm_main.R --no-save[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[KR --version
bash: R: command not found...
]0;babv971@niasra-hpc:~/R-VGAL/5_Poisson[babv971@niasra-hpc 5_Poisson]$ which Rscript
/usr/bin/which: no Rscript in (/usr/condabin:/usr/local/bin:/usr/bin:/usr/local/sbin:/usr/sbin:/usr/local/go/bin:/usr/local/sbin:/usr/local/bin:/home/babv971/.local/bin:/home/babv971/bin:/usr/local/go/bin:/usr/local/sbin:/usr/local/bin:/usr/local/go/bin:/usr/local/sbin:/usr/local/bin:/usr/local/go/bin:/usr/local/sbin:/usr/local/bin:/usr/local/go/bin:/usr/local/sbin:/usr/local/bin)
]0;babv971@niasra-hpc:~/R-VGAL/5_Poisson[babv971@niasra-hpc 5_Poisson]$ cd gome[K[K[K[K~/
]0;babv971@niasra-hpc:~[babv971@niasra-hpc ~]$ pwd
/home/babv971
]0;babv971@niasra-hpc:~[babv971@niasra-hpc ~]$ ls
[0m[38;5;27mKAUST[0m  [48;5;10;38;5;21mR[0m  [38;5;27mr4ds[0m  [38;5;27mR-VGAL[0m  [38;5;27mR-VGA-Whittle[0m  [38;5;27mSSA_backup[0m  [48;5;10;38;5;21mSSA_model[0m  [38;5;27mSTAT301_2022[0m  [48;5;10;38;5;21mSTAT902[0m  [38;5;27mSummer_project_2021[0m
]0;babv971@niasra-hpc:~[babv971@niasra-hpc ~]$ cd R
]0;babv971@niasra-hpc:~/R[babv971@niasra-hpc R]$ ls
[0m[48;5;10;38;5;21mx86_64-redhat-linux-gnu-library[0m
]0;babv971@niasra-hpc:~/R[babv971@niasra-hpc R]$ cd x86_64-redhat-linux-gnu-library/
]0;babv971@niasra-hpc:~/R/x86_64-redhat-linux-gnu-library[babv971@niasra-hpc x86_64-redhat-linux-gnu-library]$ ls
[0m[48;5;10;38;5;21m3.6[0m  [48;5;10;38;5;21m4.0[0m  [38;5;27m4.1[0m
]0;babv971@niasra-hpc:~/R/x86_64-redhat-linux-gnu-library[babv971@niasra-hpc x86_64-redhat-linux-gnu-library]$ cd 4.1
]0;babv971@niasra-hpc:~/R/x86_64-redhat-linux-gnu-library/4.1[babv971@niasra-hpc 4.1]$ ls
[0m[38;5;27mabind[0m          [38;5;27mcellranger[0m  [38;5;27mdeldir[0m          [38;5;27mfds[0m          [38;5;27mgooglesheets4[0m  [38;5;27misoband[0m       [38;5;27mMatrix[0m        [38;5;27mpcaPP[0m        [38;5;27mps[0m             [38;5;27mreadxl[0m       [38;5;27mscales[0m       [38;5;27mtextshaping[0m      [38;5;27muuid[0m
[38;5;27mAER[0m            [38;5;27mcheckmate[0m   [38;5;27mDeriv[0m           [38;5;27mfields[0m       [38;5;27mGpGp[0m           [38;5;27mjpeg[0m          [38;5;27mmatrixcalc[0m    [38;5;27mpillar[0m       [38;5;27mpurrr[0m          [38;5;27mrematch[0m      [38;5;27mselectr[0m      [38;5;27mtfautograph[0m      [38;5;27mvctrs[0m
[38;5;27malabama[0m        [38;5;27mclassInt[0m    [38;5;27mdesc[0m            [38;5;27mFNN[0m          [38;5;27mGPvecchia[0m      [38;5;27mjsonlite[0m      [38;5;27mMatrixModels[0m  [38;5;27mpkgbuild[0m     [38;5;27mqlcMatrix[0m      [38;5;27mrematch2[0m     [38;5;27msf[0m           [38;5;27mtfruns[0m           [38;5;27mviridis[0m
[38;5;27maplore3[0m        [38;5;27mcli[0m         [38;5;27mdeSolve[0m         [38;5;27mforcats[0m      [38;5;27mgridExtra[0m      [38;5;27mkeras[0m         [38;5;27mmatrixStats[0m   [38;5;27mpkgconfig[0m    [38;5;27mquadprog[0m       [38;5;27mreprex[0m       [38;5;27mslam[0m         [38;5;27mtibble[0m           [38;5;27mviridisLite[0m
[38;5;27mash[0m            [38;5;27mclipr[0m       [38;5;27mdiffobj[0m         [38;5;27mforecast[0m     [38;5;27mgtable[0m         [38;5;27mkernlab[0m       [38;5;27mmclust[0m        [38;5;27mpkgload[0m      [38;5;27mquantmod[0m       [38;5;27mreshape2[0m     [38;5;27msp[0m           [38;5;27mtidyr[0m            [38;5;27mvroom[0m
[38;5;27mastsa[0m          [38;5;27mcmdstanr[0m    [38;5;27mdistributional[0m  [38;5;27mFormula[0m      [38;5;27mhaven[0m          [38;5;27mks[0m            [38;5;27mmemoise[0m       [38;5;27mplot3D[0m       [38;5;27mquantreg[0m       [38;5;27mreticulate[0m   [38;5;27mspacetime[0m    [38;5;27mtidyselect[0m       [38;5;27mwaldo[0m
[38;5;27mbackports[0m      [38;5;27mcoda[0m        [38;5;27mdocopt[0m          [38;5;27mfracdiff[0m     [38;5;27mhdrcde[0m         [38;5;27mlabeling[0m      [38;5;27mminqa[0m         [38;5;27mplyr[0m         [38;5;27mragg[0m           [38;5;27mrlang[0m        [38;5;27mspam[0m         [38;5;27mtidyverse[0m        [38;5;27mwhisker[0m
[38;5;27mbeyondWhittle[0m  [38;5;27mcolorspace[0m  [38;5;27mdotCall64[0m       [38;5;27mFRK[0m          [38;5;27mhere[0m           [38;5;27mlatticeExtra[0m  [38;5;27mmisc3d[0m        [38;5;27mpng[0m          [38;5;27mrainbow[0m        [38;5;27mR.methodsS3[0m  [38;5;27msparseinv[0m    [38;5;27mtimechange[0m       [38;5;27mwithr[0m
[38;5;27mBH[0m             [38;5;27mconfig[0m      [38;5;27mdplyr[0m           [38;5;27mgargle[0m       [38;5;27mHmisc[0m          [38;5;27mlifecycle[0m     [38;5;27mmodelr[0m        [38;5;27mpolynom[0m      [38;5;27mrandtoolbox[0m    [38;5;27mrngWELL[0m      [38;5;27mSparseM[0m      [38;5;27mtimeDate[0m         [38;5;27mwk[0m
[38;5;27mbit[0m            [38;5;27mconflicted[0m  [38;5;27mdtplyr[0m          [38;5;27mgenerics[0m     [38;5;27mhms[0m            [38;5;27mlme4[0m          [38;5;27mmulticool[0m     [38;5;27mpomp[0m         [38;5;27mrbibutils[0m      [38;5;27mR.oo[0m         [38;5;27msparsesvd[0m    [38;5;27mTMB[0m              [38;5;27mxts[0m
[38;5;27mbit64[0m          [38;5;27mcorrplot[0m    [38;5;27me1071[0m           [38;5;27mggmatplot[0m    [38;5;27mhtmlTable[0m      [38;5;27mlmtest[0m        [38;5;27mmunsell[0m       [38;5;27mposterior[0m    [38;5;27mRColorBrewer[0m   [38;5;27mrprojroot[0m    [38;5;27mStanHeaders[0m  [38;5;27mtmvtnorm[0m         [38;5;27mzeallot[0m
[38;5;27mbitops[0m         [38;5;27mcowplot[0m     [38;5;27mellipse[0m         [38;5;27mggplot2[0m      [38;5;27mhtmlwidgets[0m    [38;5;27mlocfit[0m        [38;5;27mmvnfast[0m       [38;5;27mpracma[0m       [38;5;27mRcppArmadillo[0m  [38;5;27mrstan[0m        [38;5;27mstatmod[0m      [38;5;27mTruncatedNormal[0m  [38;5;27mzoo[0m
[38;5;27mblob[0m           [38;5;27mcpp11[0m       [38;5;27mellipsis[0m        [38;5;27mggpubr[0m       [38;5;27mhttr[0m           [38;5;27mloo[0m           [38;5;27mmvtnorm[0m       [38;5;27mpraise[0m       [38;5;27mRcppEigen[0m      [38;5;27mrstatix[0m      [38;5;27mstcos[0m        [38;5;27mtseries[0m
[38;5;27mbrio[0m           [38;5;27mcrayon[0m      [38;5;27mexpm[0m            [38;5;27mggrepel[0m      [38;5;27mids[0m            [38;5;27mLSTS[0m          [38;5;27mnleqslv[0m       [38;5;27mprettyunits[0m  [38;5;27mRcppParallel[0m   [38;5;27mrstudioapi[0m   [38;5;27mstringr[0m      [38;5;27mTTR[0m
[38;5;27mbroom[0m          [38;5;27mcurl[0m        [38;5;27mfansi[0m           [38;5;27mggsci[0m        [38;5;27minline[0m         [38;5;27mltsa[0m          [38;5;27mnloptr[0m        [38;5;27mprocessx[0m     [38;5;27mRcppTOML[0m       [38;5;27mR.utils[0m      [38;5;27msystemfonts[0m  [38;5;27mtzdb[0m
[38;5;27mcallr[0m          [38;5;27mdata.table[0m  [38;5;27mfarver[0m          [38;5;27mggsignif[0m     [38;5;27minterp[0m         [38;5;27mlubridate[0m     [38;5;27mnumDeriv[0m      [38;5;27mprofvis[0m      [38;5;27mRCurl[0m          [38;5;27mrvest[0m        [38;5;2]0;babv971@niasra-node3:~/R-VGAL/5_Poisson[?2004h[babv971@niasra-node3 5_Poisson]$ 
[?2004l]0;babv971@niasra-node3:~/R-VGAL/5_Poisson[?2004h[babv971@niasra-node3 5_Poisson]$ 
[?2004l]0;babv971@niasra-node3:~/R-VGAL/5_Poisson[?2004h[babv971@niasra-node3 5_Poisson]$ ls
[?2004l[0m[01;34mdata[0m  [01;34mmulti_sims[0m  [01;34mplots[0m  poisson_mm_main.R  poisson_multi_sims.R  [01;34mresults[0m  Rplots.pdf  [01;34msource[0m  test.R  tets.R
]0;babv971@niasra-node3:~/R-VGAL/5_Poisson[?2004h[babv971@niasra-node3 5_Poisson]$ cat testR[K.R
[?2004lScript started on Mon 20 Nov 2023 16:20:22 AEDT
]0;babv971@niasra-hpc:~/R-VGAL/5_Poisson[?1034h[babv971@niasra-hpc 5_Poisson]$ cat test.R
print("Hello")]0;babv971@niasra-hpc:~/R-VGAL/5_Poisson[babv971@niasra-hpc 5_Poisson]$ Rsrip[K[K[K[Kcript[K[K[K[K[Kscript test.R
bash: Rscript: command not found...
Similar command is: 'script'
]0;babv971@niasra-hpc:~/R-VGAL/5_Poisson[babv971@niasra-hpc 5_Poisson]$ car[K[K[Kcat test.R
print("Hello")]0;babv971@niasra-hpc:~/R-VGAL/5_Poisson[babv971@niasra-hpc 5_Poisson]$ script R[Ktest.R[K[K[K[K[K[K[K[K[K[K[K[K[Kscript tets.R
Script started, file is tets.R
]0;babv971@niasra-hpc:~/R-VGAL/5_Poisson[?1034h[babv971@niasra-hpc 5_Poisson]$ R < poisson_mm_main.R --no-save[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[K[KR --version
bash: R: command not found...
]0;babv971@niasra-hpc:~/R-VGAL/5_Poisson[babv971@niasra-hpc 5_Poisson]$ which Rscript
/usr/bin/which: no Rscript in (/usr/condabin:/usr/local/bin:/usr/bin:/usr/local/sbin:/usr/sbin:/usr/local/go/bin:/usr/local/sbin:/usr/local/bin:/home/babv971/.local/bin:/home/babv971/bin:/usr/local/go/bin:/usr/local/sbin:/usr/local/bin:/usr/local/go/bin:/usr/local/sbin:/usr/local/bin:/usr/local/go/bin:/usr/local/sbin:/usr/local/bin:/usr/local/go/bin:/usr/local/sbin:/usr/local/bin)
]0;babv971@niasra-hpc:~/R-VGAL/5_Poisson[babv971@niasra-hpc 5_Poisson]$ cd gome[K[K[K[K~/
]0;babv971@niasra-hpc:~[babv971@niasra-hpc ~]$ pwd
/home/babv971
]0;babv971@niasra-hpc:~[babv971@niasra-hpc ~]$ ls
[0m[38;5;27mKAUST[0m  [48;5;10;38;5;21mR[0m  [38;5;27mr4ds[0m  [38;5;27mR-VGAL[0m  [38;5;27mR-VGA-Whittle[0m  [38;5;27mSSA_backup[0m  [48;5;10;38;5;21mSSA_model[0m  [38;5;27mSTAT301_2022[0m  [48;5;10;38;5;21mSTAT902[0m  [38;5;27mSummer_project_2021[0m
]0;babv971@niasra-hpc:~[babv971@niasra-hpc ~]$ cd R
]0;babv971@niasra-hpc:~/R[babv971@niasra-hpc R]$ ls
[0m[48;5;10;38;5;21mx86_64-redhat-linux-gnu-library[0m
]0;babv971@niasra-hpc:~/R[babv971@niasra-hpc R]$ cd x86_64-redhat-linux-gnu-library/
]0;babv971@niasra-hpc:~/R/x86_64-redhat-linux-gnu-library[babv971@niasra-hpc x86_64-redhat-linux-gnu-library]$ ls
[0m[48;5;10;38;5;21m3.6[0m  [48;5;10;38;5;21m4.0[0m  [38;5;27m4.1[0m
]0;babv971@niasra-hpc:~/R/x86_64-redhat-linux-gnu-library[babv971@niasra-hpc x86_64-redhat-linux-gnu-library]$ cd 4.1
]0;babv971@niasra-hpc:~/R/x86_64-redhat-linux-gnu-library/4.1[babv971@niasra-hpc 4.1]$ ls
[0m[38;5;27mabind[0m          [38;5;27mcellranger[0m  [38;5;27mdeldir[0m          [38;5;27mfds[0m          [38;5;27mgooglesheets4[0m  [38;5;27misoband[0m       [38;5;27mMatrix[0m        [38;5;27mpcaPP[0m        [38;5;27mps[0m             [38;5;27mreadxl[0m       [38;5;27mscales[0m       [38;5;27mtextshaping[0m      [38;5;27muuid[0m
[38;5;27mAER[0m            [38;5;27mcheckmate[0m   [38;5;27mDeriv[0m           [38;5;27mfields[0m       [38;5;27mGpGp[0m           [38;5;27mjpeg[0m          [38;5;27mmatrixcalc[0m    [38;5;27mpillar[0m       [38;5;27mpurrr[0m          [38;5;27mrematch[0m      [38;5;27mselectr[0m      [38;5;27mtfautograph[0m      [38;5;27mvctrs[0m
[38;aven[0m          [38;5;27mks[0m            [38;5;27mmemoise[0m       [38;5;27mplot3D[0m       [38;5;27mquantreg[0m       [38;5;27mreticulate[0m   [38;5;27mspacetime[0m    [38;5;27mtidyselect[0m       [38;5;27mwaldo[0m
[38;5;27mbackports[0m      [38;5;27mcoda[0m        [38;5;27mdocopt[0m          [38;5;27mfracdiff[0m     [38;5;27mhdrcde[0m         [38;5;27mlabeling[0m      [38;5;27mminqa[0m         [38;5;27mplyr[0m         [38;5;27mragg[0m           [38;5;27mrlang[0m        [38;5;27mspam[0m         [38;5;27mtidyverse[0m        [38;5;27mwhisker[0m
[38;5;27mbeyondWhittle[0m  [38;5;27mcolorspace[0m  [38;5;27mdotCall64[0m       [38;5;27mFRK[0m          [38;5;27mhere[0m           [38;5;27mlatticeExtra[0m  [38;5;27mmisc3d[0m        [38;5;27mpng[0m          [38;5;27mrainbow[0m        [38;5;27mR.methodsS3[0m  [38;5;27msparseinv[0m    [38;5;27mtimechange[0m       [38;5;27mwithr[0m
[38;5;27mBH[0m             [38;5;27mconfig[0m      [38;5;27mdplyr[0m           [38;5;27mgargle[0m       [38;5;27mHmisc[0m          [38;5;27mlifecycle[0m     [38;5;27mmodelr[0m        [38;5;27mpolynom[0m      [38;5;27mrandtoolbox[0m    [38;5;27mrngWELL[0m      [38;5;27mSparseM[0m      [38;5;27mtimeDate[0m         [38;5;27mwk[0m
[38;5;27mbit[0m            [38;5;27mconflicted[0m  [38;5;27mdtplyr[0m          [38;5;27mgenerics[0m     [38;5;27mhms[0m            [38;5;27mlme4[0m          [38;5;27mmulticool[0m     [38;5;27mpomp[0m         [38;5;27mrbibutils[0m      [38;5;27mR.oo[0m         [38;5;27msparsesvd[0m    [38;5;27mTMB[0m              [38;5;27mxts[0m
[38;5;27mbit64[0m          [38;5;27mcorrplot[0m    [38;5;27me1071[0m           [38;5;27mggmatplot[0m    [38;5;27mhtmlTable[0m      [38;5;27mlmtest[0m        [38;5;27mmunsell[0m       [38;5;27mposterior[0m    [38;5;27mRColorBrewer[0m   [38;5;27mrprojroot[0m    [38;5;27mStanHeaders[0m  [38;5;27mtmvtnorm[0m         [38;5;27mzeallot[0m
[38;5;27mbitops[0m         [38;5;27mcowplot[0m     [38;5;27mellipse[0m         [38;5;27mggplot2[0m      [38;5;27mhtmlwidgets[0m    [38;5;27mlocfit[0m        [38;5;27mmvnfast[0m       [38;5;27mpracma[0m       [38;5;27mRcppArmadillo[0m  [38;5;27mrstan[0m        [38;5;27mstatmod[0m      [38;5;27mTruncatedNormal[0m  [38;5;27mzoo[0m
[38;5;27mblob[0m           [38;5;27mcpp11[0m       [38;5;27mellipsis[0m        [38;5;27mggpubr[0m       [38;5;27mhttr[0m           [38;5;27mloo[0m           [38;5;27mmvtnorm[0m       [38;5;27mpraise[0m       [38;5;27mRcppEigen[0m      [38;5;27mrstatix[0m      [38;5;27mstcos[0m        [38;5;27mtseries[0m
[38;5;27mbrio[0m           [38;5;27mcrayon[0m      [38;5;27mexpm[0m            [38;5;27mggrepel[0m      [38;5;27mids[0m            [38;5;27mLSTS[0m          [38;5;27mnleqslv[0m       [38;5;27mprettyunits[0m  [38;5;27mRcppParallel[0m   [38;5;27mrstudioapi[0m   [38;5;27mstringr[0m      [38;5;27mTTR[0m
[38;5;27mbroom[0m          [38;5;27mcurl[0m        [38;5;27mfansi[0m           [38;5;27mggsci[0m        [38;5;27minline[0m         [38;5;27mltsa[0m          [38;5;27mnloptr[0m        [38;5;27mprocessx[0m     [38;5;27mRcppTOML[0m       [38;5;27mR.utils[0m      [38;5;27msystemfonts[0m  [38;5;27mtzdb[0m
[38;5;27mcallr[0m          [38;5;27mdata.table[0m  [38;5;27mfarver[0m          [38;5;27mggsignif[0m     [38;5;27minterp[0m         [38;5;27mlubridate[0m     [38;5;27mnumDeriv[0m      [38;5;27mprofvis[0m      [38;5;27mRCurl[0m          [38;5;27mrvest[0m        [38;5;2]0;babv971@niasra-node3:~/R-VGAL/5_Poisson[?2004h[babv971@niasra-node3 5_Poisson]$ cat[K[K[Kcat poisson_mm_main.R
[?2004lsetwd("~/R-VGAL/5_Poisson/")
## Structure:
# 1. Generate data
# 2. Run R-VGAL algorithm
# 3. Run HMC
# 4. Plot results

rm(list=ls())

use_tensorflow <- F

if (use_tensorflow) {
  library("tensorflow")
  tfp <- import("tensorflow_probability")
  tfd <- tfp$distributions
  library(keras)
  
  # List physical devices
  gpus <- tf$config$experimental$list_physical_devices('GPU')
  
  if (length(gpus) > 0) {
    tryCatch({
      # Restrict TensorFlow to only allocate 4GB of memory on the first GPU
      tf$config$experimental$set_virtual_device_configuration(
        gpus[[1]],
        list(tf$config$experimental$VirtualDeviceConfiguration(memory_limit=2*4096))
      )
      
      logical_gpus <- tf$config$experimental$list_logical_devices('GPU')
      
      print(paste0(length(gpus), " Physical GPUs,", length(logical_gpus), " Logical GPUs"))
    }, error = function(e) {
      # Virtual devices must be set before GPUs have been initialized
      print(e)
    })
  }
  
}

library("dplyr")
library("mvtnorm")
library("rstan")
library("gridExtra")
library("grid")
library("gtable")
library(Matrix)
library(coda)
library(matrixcalc)


source("./source/run_rvgal.R")
source("./source/run_stan_poisson.R")
source("./source/generate_data.R")
source("./source/generate_data2.R")
# source("./source/compute_joint_llh_tf.R")
# source("./source/compute_grad_hessian_all.R")
source("./source/compute_grad_hessian_theoretical.R")

## Flags
date <-"20231018" #  "20231116" #has 2 fixed effects, ""20231030" has 4    
regenerate_data <- F
rerun_rvga <- F
rerun_stan <- T
save_data <- F
save_rvgal_results <- F
save_hmc_results <- F
plot_prior <- F
save_plots <- T
reorder_data <- F
use_tempering <- T

plot_trace <- F

if (use_tempering) {
  n_obs_to_temper <- 10
  K <- 4
  a_vals_temper <- rep(1/K, K)
}

n_post_samples <- 20000
n_random_effects <- 2

## Generate data
set.seed(2023)
N <- 200L #number of individuals
n <- 10L # number of responses per individual

beta <- 0
Sigma_alpha <- 0
if (date == "20231116") {
  beta <- c(6.56, -0.23, 0.58)
  Sigma_alpha <- matrix(c(0.54, -0.013, -0.013, 0.01), 2, 2)
} else {
  beta <- c(-0.5, 1.25) 
  nlower <- n_random_effects + n_random_effects * (n_random_effects-1)/2
  
  Sigma_alpha <- 0
  if (grepl("_0", date)) {
    Sigma_alpha <- 0.1*diag(1:n_random_effects)
  } else {
    L <- matrix(0, n_random_effects, n_random_effects)
    L[lower.tri(L, diag = T)] <- runif(nlower, 0, 1)
    Sigma_alpha <- tcrossprod(L)
    Sigma_alpha <- Sigma_alpha + 0.1*diag(1:n_random_effects)
    # Sigma_alpha <- matrix(c(0.5, 0.15, 0.15, 0.3), 2, 2)
  }
}

if (regenerate_data) {
  if (date == "20231116") {
    poisson_data <- generate_data2(N = N, n = n, beta = beta, 
                                   Sigma_alpha = Sigma_alpha,
                                   seed = 2023)
  } else {
    poisson_data <- generate_data(N = N, n = n, beta = beta, 
                                  Sigma_alpha = Sigma_alpha,
                                  seed = 2023)
  }
  
  if (save_data) {
    saveRDS(poisson_data, file = paste0("./data/poisson_data_N", N, "_n", n, 
                                        "_", n_random_effects, "d_", date, ".rds"))
  }
} else {
  poisson_data <- readRDS(file = paste0("./data/poisson_data_N", N, "_n", n, 
                                        "_", n_random_effects, "d_", date, ".rds"))
}

y <- poisson_data$y
X <- poisson_data$X
Z <- poisson_data$Z

beta <- poisson_data$beta
Sigma_alpha <- poisson_data$Sigma_alpha

## Reorder data if needed
if (reorder_data) {
  set.seed(reorder_seed) 
  reordered_ind <- sample(1:length(y))
  print(head(reordered_ind))
  reordered_y <- lapply(reordered_ind, function(i) y[[i]])
  reordered_X <- lapply(reordered_ind, function(i) X[[i]])
  
  y <- reordered_y
  X <- reordered_X
}

hist(unlist(y))
###################
##     R-VGA     ##
###################
S <- 20L
S_alpha <- 20L

## Set up result directory
if (use_tempering) {
  temper_info <- paste0("_temper", n_obs_to_temper)
} else {
  temper_info <- ""
}

if (reorder_data) {
  reorder_info <- paste0("_seed", reorder_seed)
} else {
  reorder_info <- ""
}
result_directory <- paste0("./results/", n_random_effects, "d/")
results_file <- paste0("poisson"./data/poisson_data_N", N, "_n", n, 
                                        "_", n_random_effects, "d_", date, ".rds"))
  }
} else {
  poisson_data <- readRDS(file = paste0("./data/poisson_data_N", N, "_n", n, 
                                        "_", n_random_effects, "d_", date, ".rds"))
}

y <- poisson_data$y
X <- poisson_data$X
Z <- poisson_data$Z

beta <- poisson_data$beta
Sigma_alpha <- poisson_data$Sigma_alpha

## Reorder data if needed
if (reorder_data) {
  set.seed(reorder_seed) 
  reordered_ind <- sample(1:length(y))
  print(head(reordered_ind))
  reordered_y <- lapply(reordered_ind, function(i) y[[i]])
  reordered_X <- lapply(reordered_ind, function(i) X[[i]])
  
  y <- reordered_y
  X <- reordered_X
}

hist(unlist(y))
###################
##     R-VGA     ##
###################
S <- 20L
S_alpha <- 20L

## Set up result directory
if (use_tempering) {
  temper_info <- paste0("_temper", n_obs_to_temper)
} else {
  temper_info <- ""
}

if (reorder_data) {
  reorder_info <- paste0("_seed", reorder_seed)
} else {
  reorder_info <- ""
}
result_directory <- paste0("./results/", n_random_effects, "d/")
results_file <- paste0("poisson_mm_rvga", temper_info, reorder_info, 
                       "_N", N, "_n", n, "_S", S, "_Sa", S_alpha, "_", date, ".rds")


## Initialise variational parameters
n_fixed_effects <- as.integer(ncol(X[[1]]))
n_random_effects <- as.integer(ncol(Z[[1]]))
n_elements_L <- n_random_effects + n_random_effects * (n_random_effects - 1)/2
param_dim <- n_fixed_effects + n_elements_L

beta_0 <- rep(0, n_fixed_effects)
l_vec_0 <- c(rep(0, n_random_effects), rep(0, n_random_effects * (n_random_effects - 1)/2))
mu_0 <- c(beta_0, l_vec_0)
P_0 <- diag(c(rep(1, n_fixed_effects), rep(0.1, n_elements_L)))

## Plot prior samples first
if (n_random_effects == 2) {
  param_names <- c(sapply(1:n_fixed_effects, function(x) paste0("beta[", x, "]")), 
                   "Sigma_alpha[1,1]", 
                   "Sigma_alpha[2,1]", "Sigma_alpha[2,2]")
  
} else {
  param_names <- c(sapply(1:n_fixed_effects, function(x) paste0("beta[", x, "]")), 
                   "Sigma_alpha[1,1]", 
                   "Sigma_alpha[2,1]",
                   "Sigma_alpha[2,2]", "Sigma_alpha[3,1]",
                   "Sigma_alpha[3,2]", "Sigma_alpha[3,3]")
}

if (plot_prior) {
  
  n_prior_samples <- 1000
  prior_samples <- rmvnorm(n_prior_samples, mu_0, P_0)
  
  rvgal.Sigma_prior_samples <- list()
  for (k in 1:n_prior_samples) {
    rvgal.Sigma_prior_samples[[k]] <- construct_Sigma(prior_samples[k, -(1:n_fixed_effects)], 
                                                      n_random_effects)
  }
  
  rvgal.prior_samples <- matrix(NA, nrow = n_prior_samples, ncol = param_dim)
  rvgal.prior_samples[, 1:n_fixed_effects] <- prior_samples[, 1:n_fixed_effects]
  
  nlower <- n_random_effects * (n_random_effects-1)/2 + n_random_effects
  lower_ind <- lapply(1:nlower, index_to_i_j_rowwise_diag)
  for (d in 1:(param_dim - n_fixed_effects)) {
    inds <- lower_ind[[d]]
    rvgal.prior_samples[, n_fixed_effects+d] <- unlist(lapply(rvgal.Sigma_prior_samples, function(Sigma) Sigma[inds[1], inds[2]]))
  }
  
  
  par(mfrow = c(2,3))
  true_vals <- c(beta, c(Sigma_alpha[t(lower.tri(Sigma_alpha, diag = T))]))
  for (p in 1:param_dim) {
    plot(density(rvgal.prior_samples[, p]))
    abline(v = true_vals[p], lty = 2)
  }
}

#################
##     R-VGA   ##
#################

if (rerun_rvga) {
  rvgal_results <- run_rvgal(y, X, Z, mu_0, P_0, 
                             S = S, S_alpha = S_alpha,
                             n_post_samples = n_post_samples,
                             use_tempering = use_tempering, 
                             n_temper = n_obs_to_temper, 
                             temper_schedule = a_vals_temper,
                             use_tf = use_tensorflow)
  
  if (save_rvgal_results) {
    saveRDS(rvgal_results, file = paste0(result_directory, results_file))
  }
  
} else {
  rvgal_results <- readRDS(file = paste0(result_directory, results_file))
}


rvgal.post_samples <- rvgal_results$post_samples

# rvgal.Sigma_post_samples <- list()
# for (k in 1:n_post_samples) {
#   rvgal.Sigma_post_samples[[k]] <- construct_Sigma(rvgal.post_samples[k, -(1:n_fixed_effects)], 
#                                                    n_random_effects)
# }
# 
# nlower <- n_random_effects * (n_random_effects-1)/2 + n_random_effects
# lower_ind <- lapply(1:nlower, index_to_i_j_rowwise_diag)
# for (d in 1:(param_dim - n_fixed_effects)) {
#   inds <- lower_ind[[d]]
#   rvgal.post_samples[, n_fixed_effects+d] <- unlist(lapply(rvgal.Sigma_post_samples, function(Sigma) Sigma[inds[1], inds[2]]))
# }

# ########################
# ##        STAN        ##
# ########################
burn_in <- 5000
n_chains <- 2
hmc.iters <- n_post_samples/n_chains + burn_in

if (rerun_stan) {
  
  ## Data manipulation ##
  y_long <- unlist(y) #as.vector(t(y))
  X_long <- do.call("rbind", X)
  Z_long <- do.call("rbind", Z)
  
  hmc_results <- run_stan_poisson(iters = hmc.iters, burn_in = burn_in,
                                  n_chains = n_chains, data = y_long,
                                  grouping = rep(1:N, each = n), n_groups = N,
                                  fixed_covariates = X_long,
                                  rand_covariates = Z_long,
                                  prior_mean = mu_0,
                                  prior_var = P_0)
  
  if (save_hmc_results) {
    saveRDS(hmc_results, file = paste0(result_directory, "poisson_mm_hmc_N", N, "_n", n, "_", date, ".rds"))
  }
  
} else {
  hmc_results <- readRDS(file = paste0(result_directory, "poisson_mm_hmc_N", N, "_n", n, "_", date, ".rds")) # for the experiements on starting points
  
}

# param_names <- c("beta[1]","beta[2]", "Sigma_alpha[1,1]", 
#                  "Sigma_alpha[2,1]",
#                  "Sigma_alpha[2,2]", "Sigma_alpha[3,1]",
#                  "Sigma_alpha[3,2]", "Sigma_alpha[3,3]")
# 
# hmc.fit <- extract(hfit, pars = param_names,
#                    permuted = F, inc_warmup = F)

hmc.fit <- hmc_results$post_samples[-(1:burn_in),,]
hmc.summ <- hmc_results$summary
hmc.n_eff <- hmc_results$n_eff
hmc.Rhat <- hmc_results$Rhat

######################## Results #########################

# rvgal.post_samples <- matrix(NA, nrow = n_post_samples, ncol = param_dim)
hmc.samples <- matrix(NA, n_post_samples, param_dim)

for (p in 1:param_dim) {
  if (length(dim(hmc.fit)) < 3) {
    hmc.samples[, p] <- rbind(hmc.fit[, p])
  } else {
    hmc.samples[, p] <- rbind(hmc.fit[, , p]) 
  }
}

param_names <- c("beta[1]", "beta[2]", "sigma_alpha[11]", "sigma_alpha[21]", "sigma_alpha[22]")  
true_vals <- c(beta, c(Sigma_alpha[t(lower.tri(Sigma_alpha, diag = T))]))

# par(mfrow = c(n_random_effects, ceiling(param_dim/n_random_effects)))
# for (p in 1:param_dim) {
#   plot(density(hmc.samples[, p]), main = param_names[p])
#   lines(density(rvgal.post_samples[, p]), col = "red")
#   abline(v = true_vals[p], lty = 2)
# }

## ggplot version
# true_vals.df <- data.frame(beta1 = beta[1], beta2 = beta[2],
#                            sigma_alpha11 = Sigma_alpha[1,1],
#                            sigma_alpha21 = Sigma_alpha[2,1],
#                            sigma_alpha22 = Sigma_alpha[2,2])

# true_vals.df <- data.frame(param = param_names, param_vals = true_vals)

rvgal.df <- data.frame(beta = rvgal.post_samples) 
hmc.df <- data.frame(beta = hmc.samples)
colnames(rvgal.df) <- param_names
colnames(hmc.df) <- param_names

plots <- list()

for (p in 1:param_dim) {
  true_vals.df <- data.frame(param = param_names[p], val = true_vals[p])
  
  plot <- ggplot(rvgal.df, aes(x = .data[[param_names[p]]])) + 
    geom_density(col = "red", lwd = 1) +
    geom_density(data = hmc.df, col = "blue", lwd = 1) +
    geom_vline(data = true_vals.df, aes(xintercept=val),
               color="black", linetype="dashed", linewidth = 0.75) +
    labs(x = bquote(beta[.(p)])) +
    theme_bw() + 
    theme(axis.title = element_blank(), axis.text = element_text(size = 18)) +                               # Assign pretty axis ticks
    scale_x_continuous(breaks = scales::pretty_breaks(n = 2)) 
  # theme(legend.position="bottom") + 
  # scale_color_manual(values = c('RVGA' = 'red', 'HMC' = 'blue'))
  
  plots[[p]] <- plot  
}

## Posterior covariance plot

## Function to map indices of plots inside a list to matrix (i,j) indices
## for arranging the plots in a lower triangular formation
n_lower_tri <- (param_dim^2 - param_dim)/2

index_to_i_j_colwise_nodiag <- function(k, n) {
  kp <- n * (n - 1) / 2 - k
  p  <- floor((sqrt(1 + 8 * kp) - 1) / 2)
  i  <- n - (kp - p * (p + 1) / 2)
  j  <- n - 1 - p
  c(i, j)
}

cov_plots <- list()
for (ind in 1:n_lower_tri) {
  mat_ind <- index_to_i_j_colwise_nodiag(ind, param_dim)
  p <- mat_ind[1]
  q <- mat_ind[2]
  
  param_df <- data.frame(x = true_vals[q], y = true_vals[p])
  
  # cov_plot <- ggplot(rvgal.df, aes_string(x = param_names[p], y = param_names[q])) +
  cov_plot <- ggplot(rvgal.df, aes(x = .data[[param_names[q]]], y = .data[[param_names[p]]])) +
    stat_ellipse(col = "goldenrod", type = "norm", lwd = 1) +
    stat_ellipse(data = rvgal.df, col = "red", type = "norm", lwd = 1) +
    stat_ellipse(data = hmc.df, col = "blue", type = "norm", lwd = 1) +
    geom_point(data = param_df, aes(x = x, y = y),
               shape = 4, color = "black", size = 4) +
    theme_bw() +
    theme(axis.title = element_blank(), axis.text = element_text(size = 18)) +                               # Assign pretty axis ticks
    scale_x_continuous(breaks = scales::pretty_breaks(n = 2)) 
  
  cov_plots[[ind]] <- cov_plot
}

m <- matrix(NA, param_dim, param_dim)
n_cov_plots <- param_dim * (param_dim-1)/2
m[lower.tri(m, diag = F)] <- 1:n_cov_plots
gr <- grid.arrange(grobs = cov_plots, layout_matrix = m)
gr2 <- gtable_add_cols(gr, unit(1, "null"), -1)
gr3 <- gtable_add_grob(gr2, grobs = lapply(plots, ggplotGrob), t = 1:param_dim, l = 1:param_dim)
# gtable_show_layout(gr3)

# A list of text grobs - the labels
vars <- list(textGrob(bquote(beta[1])), textGrob(bquote(beta[2])), 
             textGrob(bquote(Sigma[alpha[11]])), textGrob(bquote(Sigma[alpha[21]])),
             textGrob(bquote(Sigma[alpha[22]])))
vars <- lapply(vars, editGrob, gp = gpar(col = "black", fontsize = 20))

# So that there is space for the labels,
# add a row to the top of the gtable,
# and a column to the left of the gtable.
gp <- gtable_add_cols(gr3, unit(1.5, "lines"), 0)
gp <- gtable_add_rows(gp, unit(1.5, "lines"), -1) #0 adds on the top

# gtable_show_layout(gp)

# Add the label grobs.
# The labels on the left should be rotated; hence the edit.
# t and l refer to cells in the gtable layout.
# gtable_show_layout(gp) shows the layout.
gp <- gtable_add_grob(gp, lapply(vars[1:param_dim], editGrob, rot = 90), t = 1:param_dim, l = 1) # add column names to column 1, rows 2:9
gp <- gtable_add_grob(gp, vars[1:param_dim], t = param_dim+1, l = 2:(param_dim+1)) # add row names to row 6, columns 1:9

grid.newpage()
grid.draw(gp)

if (save_plots) {
  plot_file <- paste0("poisson_posterior", temper_info, reorder_info,
                      "_S", S, "_Sa", S_alpha, "_", date, ".png")
  filepath = paste0("./plots/", plot_file)
  png(filepath, width = 1000, height = 700)
  grid.newpage()
  grid.draw(gp)
  dev.off()
} 

## Trajectory for R-VGA
if (plot_trace) {
  par(mfrow = c(2, ceiling(param_dim/2)))
  trajectories <- list()
  for (p in 1:param_dim) {
    # if (p > n_fixed_effects && p <= (n_fixed_effects + n_random_effects)) {
    #   trajectories[[p]] <- sapply(1:N, function(x) exp(rvgal_results$mu[[x]][p])^2)
    # } else {
    trajectories[[p]] <- sapply(1:N, function(x) rvgal_results$mu[[x]][p])
    # }
    plot(trajectories[[p]], main = param_names[p], type = "l")
    abline(h = true_vals[p], lty = 2, col = "red")
  }
  
  ## HMC traceplots
  par(mfrow = c(ceiling(param_dim/2), 2))
  for (p in 1:param_dim) {
    plot(hmc.samples[,p], type = "l", main = param_names[p])
    abline(h = true_vals[p], lty = 2, col = "red")
  }
  
}

## Time benchmark
hmc.time <- sum(colSums(hmc_results$time)) # sum over all chains
rvga.time <- rvgal_results$time_elapsed
cat("HMC time:", hmc.time, ", R-VGAL time:", rvga.time[3], "\n")


gc()
tf$keras$backend$clear_session()]0;babv971@niasra-node3:~/R-VGAL/5_Poisson[?2004h[babv971@niasra-node3 5_Poisson]$ 
[?2004l]0;babv971@niasra-node3:~/R-VGAL/5_Poisson[?2004h[babv971@niasra-node3 5_Poisson]$ 
[?2004l]0;babv971@niasra-node3:~/R-VGAL/5_Poisson[?2004h[babv971@niasra-node3 5_Poisson]$ hea [Kd poisson_mm_main.R
[?2004lsetwd("~/R-VGAL/5_Poisson/")
## Structure:
# 1. Generate data
# 2. Run R-VGAL algorithm
# 3. Run HMC
# 4. Plot results

rm(list=ls())

use_tensorflow <- F
]0;babv971@niasra-node3:~/R-VGAL/5_Poisson[?2004h[babv971@niasra-node3 5_Poisson]$ [K[babv971@niasra-node3 5_Poisson]$ [K[babv971@niasra-node3 5_Poisson]$ head poisson_mm_main.R[1Pcat[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[1@head[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[Khead poisson_mm_main.R[1Pcat[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C
[?2004lsetwd("~/PhD/R-VGAL/R-VGAL_rev/5_Poisson/")
## Structure:
# 1. Generate data
# 2. Run R-VGAL algorithm
# 3. Run HMC
# 4. Plot results

rm(list=ls())

use_tensorflow <- F

if (use_tensorflow) {
  library("tensorflow")
  tfp <- import("tensorflow_probability")
  tfd <- tfp$distributions
  library(keras)
  
  # List physical devices
  gpus <- tf$config$experimental$list_physical_devices('GPU')

  if (length(gpus) > 0) {
    tryCatch({
      # Restrict TensorFlow to only allocate 4GB of memory on the first GPU
      tf$config$experimental$set_virtual_device_configuration(
        gpus[[1]],
        list(tf$config$experimental$VirtualDeviceConfiguration(memory_limit=2*4096))
      )

      logical_gpus <- tf$config$experimental$list_logical_devices('GPU')

      print(paste0(length(gpus), " Physical GPUs,", length(logical_gpus), " Logical GPUs"))
    }, error = function(e) {
      # Virtual devices must be set before GPUs have been initialized
      print(e)
    })
  }
  
}

library("dplyr")
library("mvtnorm")
library("rstan")
library("gridExtra")
library("grid")
library("gtable")
library(Matrix)
library(coda)
library(matrixcalc)


source("./source/run_rvgal.R")
source("./source/run_stan_poisson.R")
source("./source/generate_data.R")
source("./source/generate_data2.R")
# source("./source/compute_joint_llh_tf.R")
# source("./source/compute_grad_hessian_all.R")
source("./source/compute_grad_hessian_theoretical.R")

## Flags
date <-"20231018" #  "20231116" #has 2 fixed effects, ""20231030" has 4    
regenerate_data <- F
rerun_rvga <- T
rerun_stan <- F
save_data <- F
save_rvgal_results <- F
save_hmc_results <- F
plot_prior <- F
save_plots <- T
reorder_data <- F
use_tempering <- T

plot_trace <- F

if (use_tempering) {
  n_obs_to_temper <- 10
  K <- 4
  a_vals_temper <- rep(1/K, K)
}

n_post_samples <- 20000
n_random_effects <- 2

## Generate data
set.seed(2023)
N <- 200L #number of individuals
n <- 10L # number of responses per individual

beta <- 0
Sigma_alpha <- 0
if (date == "20231116") {
  beta <- c(6.56, -0.23, 0.58)
  Sigma_alpha <- matrix(c(0.54, -0.013, -0.013, 0.01), 2, 2)
} else {
  beta <- c(-0.5, 1.25) 
  nlower <- n_random_effects + n_random_effects * (n_random_effects-1)/2
  
  Sigma_alpha <- 0
  if (grepl("_0", date)) {
    Sigma_alpha <- 0.1*diag(1:n_random_effects)
  } else {
    L <- matrix(0, n_random_effects, n_random_effects)
    L[lower.tri(L, diag = T)] <- runif(nlower, 0, 1)
    Sigma_alpha <- tcrossprod(L)
    Sigma_alpha <- Sigma_alpha + 0.1*diag(1:n_random_effects)
    # Sigma_alpha <- matrix(c(0.5, 0.15, 0.15, 0.3), 2, 2)
  }
}

if (regenerate_data) {
  if (date == "20231116") {
    poisson_data <- generate_data2(N = N, n = n, beta = beta, 
                                   Sigma_alpha = Sigma_alpha,
                                   seed = 2023)
  } else {
    poisson_data <- generate_data(N = N, n = n, beta = beta, 
                                  Sigma_alpha = Sigma_alpha,
                                  seed = 2023)
  }
  
  if (save_data) {
    saveRDS(poisson_data, file = paste0("./data/poisson_data_N", N, "_n", n, 
                                        "_", n_random_effects, "d_", date, ".rds"))
  }
} else {
  poisson_data <- readRDS(file = paste0("./data/poisson_data_N", N, "_n", n, 
                                        "_", n_random_effects, "d_", date, ".rds"))
}

y <- poisson_data$y
X <- poisson_data$X
Z <- poisson_data$Z

beta <- poisson_data$beta
Sigma_alpha <- poisson_data$Sigma_alpha

## Reorder data if needed
if (reorder_data) {
  set.seed(reorder_seed) 
  reordered_ind <- sample(1:length(y))
  print(head(reordered_ind))
  reordered_y <- lapply(reordered_ind, function(i) y[[i]])
  reordered_X <- lapply(reordered_ind, function(i) X[[i]])
  
  y <- reordered_y
  X <- reordered_X
}

hist(unlist(y))
###################
##     R-VGA     ##
###################
S <- 20L
S_alpha <- 20L

## Set up result directory
if (use_tempering) {
  temper_info <- paste0("_temper", n_obs_to_temper)
} else {
  temper_info <- ""
}

if (reorder_data) {
  reorder_info <- paste0("_seed", reorder_seed)
} else {
  reorder_info <- ""
}
result_directory <- paste0("./results/", n_random_effects, "d/")
results_file <- paste0("poisson_mm_rvga", temper_info, reorder_info, 
                       "_N", N, "_n", n, "_S", S, "_Sa", S_alpha, "_", date, ".rds")


## Initialise variational parameters
n_fixed_effects <- as.integer(ncol(X[[1]]))
n_random_effects <- as.integer(ncol(Z[[1]]))
n_elements_L <- n_random_effects + n_random_effects * (n_random_effects - 1)/2
param_dim <- n_fixed_effects + n_elements_L

beta_0 <- rep(0, n_fixed_effects)
l_vec_0 <- c(rep(0, n_random_effects), rep(0, n_random_effects * (n_random_effects - 1)/2))
mu_0 <- c(beta_0, l_vec_0)
P_0 <- diag(c(rep(1, n_fixed_effects), rep(0.1, n_elements_L)))

## Plot prior samples first
if (n_random_effects == 2) {
  param_names <- c(sapply(1:n_fixed_effects, function(x) paste0("beta[", x, "]")), 
                   "Sigma_alpha[1,1]", 
                   "Sigma_alpha[2,1]", "Sigma_alpha[2,2]")
  
} else {
  param_names <- c(sapply(1:n_fixed_effects, function(x) paste0("beta[", x, "]")), 
                   "Sigma_alpha[1,1]", 
                   "Sigma_alpha[2,1]",
                   "Sigma_alpha[2,2]", "Sigma_alpha[3,1]",
                   "Sigma_alpha[3,2]", "Sigma_alpha[3,3]")
}

if (plot_prior) {
  
  n_prior_samples <- 1000
  prior_samples <- rmvnorm(n_prior_samples, mu_0, P_0)
  
  rvgal.Sigma_prior_samples <- list()
  for (k in 1:n_prior_samples) {
    rvgal.Sigma_prior_samples[[k]] <- construct_Sigma(prior_samples[k, -(1:n_fixed_effects)], 
                                                      n_random_effects)
  }
  
  rvgal.prior_samples <- matrix(NA, nrow = n_prior_samples, ncol = param_dim)
  rvgal.prior_samples[, 1:n_fixed_effects] <- prior_samples[, 1:n_fixed_effects]
  
  nlower <- n_random_effects * (n_random_effects-1)/2 + n_random_effects
  lower_ind <- lapply(1:nlower, index_to_i_j_rowwise_diag)
  for (d in 1:(param_dim - n_fixed_effects)) {
    inds <- lower_ind[[d]]
    rvgal.prior_samples[, n_fixed_effects+d] <- unlist(lapply(rvgal.Sigma_prior_samples, function(Sigma) Sigma[inds[1], inds[2]]))
  }
  
  
  par(mfrow = c(2,3))
  true_vals <- c(beta, c(Sigma_alpha[t(lower.tri(Sigma_alpha, diag = T))]))
  for (p in 1:param_dim) {
    plot(density(rvgal.prior_samples[, p]))
    abline(v = true_vals[p], lty = 2)
  }
}

#################
##     R-VGA   ##
#################

if (rerun_rvga) {
  rvgal_results <- run_rvgal(y, X, Z, mu_0, P_0, 
                             S = S, S_alpha = S_alpha,
                             n_post_samples = n_post_samples,
                             use_tempering = use_tempering, 
                             n_temper = n_obs_to_temper, 
                             temper_schedule = a_vals_temper,
                             use_tf = use_tensorflow)
  
  if (save_rvgal_results) {
    saveRDS(rvgal_results, file = paste0(result_directory, results_file))
  }
  
} else {
  rvgal_results <- readRDS(file = paste0(result_directory, results_file))
}


rvgal.post_samples <- rvgal_results$post_samples

# rvgal.Sigma_post_samples <- list()
# for (k in 1:n_post_samples) {
#   rvgal.Sigma_post_samples[[k]] <- construct_Sigma(rvgal.post_samples[k, -(1:n_fixed_effects)], 
#                                                    n_random_effects)
# }
# 
# nlower <- n_random_effects * (n_random_effects-1)/2 + n_random_effects
# lower_ind <- lapply(1:nlower, index_to_i_j_rowwise_diag)
# for (d in 1:(param_dim - n_fixed_effects)) {
#   inds <- lower_ind[[d]]
#   rvgal.post_samples[, n_fixed_effects+d] <- unlist(lapply(rvgal.Sigma_post_samples, function(Sigma) Sigma[inds[1], inds[2]]))
# }

# ########################
# ##        STAN        ##
# ########################
burn_in <- 5000
n_chains <- 2
hmc.iters <- n_post_samples/n_chains + burn_in

if (rerun_stan) {
  
  ## Data manipulation ##
  y_long <- unlist(y) #as.vector(t(y))
  X_long <- do.call("rbind", X)
  Z_long <- do.call("rbind", Z)
  
  hmc_results <- run_stan_poisson(iters = hmc.iters, burn_in = burn_in,
                                  n_chains = n_chains, data = y_long,
                                  grouping = rep(1:N, each = n), n_groups = N,
                                  fixed_covariates = X_long,
                                  rand_covariates = Z_long,
                                  prior_mean = mu_0,
                                  prior_var = P_0)
  
  if (save_hmc_results) {
    saveRDS(hmc_results, file = paste0(result_directory, "poisson_mm_hmc_N", N, "_n", n, "_", date, ".rds"))
  }
  
} else {
  hmc_results <- readRDS(file = paste0(result_directory, "poisson_mm_hmc_N", N, "_n", n, "_", date, ".rds")) # for the experiements on starting points
  
}

# param_names <- c("beta[1]","beta[2]", "Sigma_alpha[1,1]", 
#                  "Sigma_alpha[2,1]",
#                  "Sigma_alpha[2,2]", "Sigma_alpha[3,1]",
#                  "Sigma_alpha[3,2]", "Sigma_alpha[3,3]")
# 
# hmc.fit <- extract(hfit, pars = param_names,
#                    permuted = F, inc_warmup = F)

hmc.fit <- hmc_results$post_samples[-(1:burn_in),,]
hmc.summ <- hmc_results$summary
hmc.n_eff <- hmc_results$n_eff
hmc.Rhat <- hmc_results$Rhat

######################## Results #########################

# rvgal.post_samples <- matrix(NA, nrow = n_post_samples, ncol = param_dim)
hmc.samples <- matrix(NA, n_post_samples, param_dim)

for (p in 1:param_dim) {
  if (length(dim(hmc.fit)) < 3) {
    hmc.samples[, p] <- rbind(hmc.fit[, p])
  } else {
    hmc.samples[, p] <- rbind(hmc.fit[, , p]) 
  }
}

param_names <- c("beta[1]", "beta[2]", "sigma_alpha[11]", "sigma_alpha[21]", "sigma_alpha[22]")  
true_vals <- c(beta, c(Sigma_alpha[t(lower.tri(Sigma_alpha, diag = T))]))

# par(mfrow = c(n_random_effects, ceiling(param_dim/n_random_effects)))
# for (p in 1:param_dim) {
#   plot(density(hmc.samples[, p]), main = param_names[p])
#   lines(density(rvgal.post_samples[, p]), col = "red")
#   abline(v = true_vals[p], lty = 2)
# }

## ggplot version
# true_vals.df <- data.frame(beta1 = beta[1], beta2 = beta[2],
#                            sigma_alpha11 = Sigma_alpha[1,1],
#                            sigma_alpha21 = Sigma_alpha[2,1],
#                            smatrix (i,j) indices
## for arranging the plots in a lower triangular formation
n_lower_tri <- (param_dim^2 - param_dim)/2

index_to_i_j_colwise_nodiag <- function(k, n) {
  kp <- n * (n - 1) / 2 - k
  p  <- floor((sqrt(1 + 8 * kp) - 1) / 2)
  i  <- n - (kp - p * (p + 1) / 2)
  j  <- n - 1 - p
  c(i, j)
}

cov_plots <- list()
for (ind in 1:n_lower_tri) {
  mat_ind <- index_to_i_j_colwise_nodiag(ind, param_dim)
  p <- mat_ind[1]
  q <- mat_ind[2]
  
  param_df <- data.frame(x = true_vals[q], y = true_vals[p])
  
  # cov_plot <- ggplot(rvgal.df, aes_string(x = param_names[p], y = param_names[q])) +
  cov_plot <- ggplot(rvgal.df, aes(x = .data[[param_names[q]]], y = .data[[param_names[p]]])) +
    stat_ellipse(col = "goldenrod", type = "norm", lwd = 1) +
    stat_ellipse(data = rvgal.df, col = "red", type = "norm", lwd = 1) +
    stat_ellipse(data = hmc.df, col = "blue", type = "norm", lwd = 1) +
    geom_point(data = param_df, aes(x = x, y = y),
               shape = 4, color = "black", size = 4) +
    theme_bw() +
    theme(axis.title = element_blank(), axis.text = element_text(size = 18)) +                               # Assign pretty axis ticks
    scale_x_continuous(breaks = scales::pretty_breaks(n = 2)) 
  
  cov_plots[[ind]] <- cov_plot
}

m <- matrix(NA, param_dim, param_dim)
n_cov_plots <- param_dim * (param_dim-1)/2
m[lower.tri(m, diag = F)] <- 1:n_cov_plots
gr <- grid.arrange(grobs = cov_plots, layout_matrix = m)
gr2 <- gtable_add_cols(gr, unit(1, "null"), -1)
gr3 <- gtable_add_grob(gr2, grobs = lapply(plots, ggplotGrob), t = 1:param_dim, l = 1:param_dim)
# gtable_show_layout(gr3)

# A list of text grobs - the labels
vars <- list(textGrob(bquote(beta[1])), textGrob(bquote(beta[2])), 
             textGrob(bquote(Sigma[alpha[11]])), textGrob(bquote(Sigma[alpha[21]])),
             textGrob(bquote(Sigma[alpha[22]])))
vars <- lapply(vars, editGrob, gp = gpar(col = "black", fontsize = 20))

# So that there is space for the labels,
# add a row to the top of the gtable,
# and a column to the left of the gtable.
gp <- gtable_add_cols(gr3, unit(1.5, "lines"), 0)
gp <- gtable_add_rows(gp, unit(1.5, "lines"), -1) #0 adds on the top

# gtable_show_layout(gp)

# Add the label grobs.
# The labels on the left should be rotated; hence the edit.
# t and l refer to cells in the gtable layout.
# gtable_show_layout(gp) shows the layout.
gp <- gtable_add_grob(gp, lapply(vars[1:param_dim], editGrob, rot = 90), t = 1:param_dim, l = 1) # add column names to column 1, rows 2:9
gp <- gtable_add_grob(gp, vars[1:param_dim], t = param_dim+1, l = 2:(param_dim+1)) # add row names to row 6, columns 1:9

grid.newpage()
grid.draw(gp)

if (save_plots) {
  plot_file <- paste0("poisson_posterior", temper_info, reorder_info,
                      "_S", S, "_Sa", S_alpha, "_", date, ".png")
  filepath = paste0("./plots/", plot_file)
  png(filepath, width = 1000, height = 700)
  grid.newpage()
  grid.draw(gp)
  dev.off()
} 

## Trajectory for R-VGA
if (plot_trace) {
  par(mfrow = c(2, ceiling(param_dim/2)))
  trajectories <- list()
  for (p in 1:param_dim) {
    # if (p > n_fixed_effects && p <= (n_fixed_effects + n_random_effects)) {
    #   trajectories[[p]] <- sapply(1:N, function(x) exp(rvgal_results$mu[[x]][p])^2)
    # } else {
    trajectories[[p]] <- sapply(1:N, function(x) rvgal_results$mu[[x]][p])
    # }
    plot(trajectories[[p]], main = param_names[p], type = "l")
    abline(h = true_vals[p], lty = 2, col = "red")
  }
  
  ## HMC traceplots
  par(mfrow = c(ceiling(param_dim/2), 2))
  for (p in 1:param_dim) {
    plot(hmc.samples[,p], type = "l", main = param_names[p])
    abline(h = true_vals[p], lty = 2, col = "red")
  }
  
}

## Time benchmark
hmc.time <- sum(colSums(hmc_results$time)) # sum over all chains
rvga.time <- rvgal_results$time_elapsed
cat("HMC time:", hmc.time, ", R-VGAL time:", rvga.time[3], "\n")


gc()
tf$keras$backend$clear_session()]0;babv971@niasra-node3:~/R-VGAL/5_Poisson[?2004h[babv971@niasra-node3 5_Poisson]$ cat poisson_mm_main.R[1@head[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[1Pcat[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[Kcat poisson_mm_main.R[1@head[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[1Pcat[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[11Ptest.Rls[Kcat test.Rls[Kcat test.Rpoisson_mm_main.R[1@head[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[1Pcat[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[KRscript o[Kpoisson_mm_main.R
[?2004lError in setwd("~/PhD/R-VGAL/R-VGAL_rev/5_Poisson/") : 
  cannot change working directory
Execution halted
]0;babv971@niasra-node3:~/R-VGAL/5_Poisson[?2004h[babv971@niasra-node3 5_Poisson]$ Rscript poisson_mm_main.R[4Pca[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[4@Rscrip[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C
[?2004l
Attaching package: ‘dplyr’

The following objects are masked from ‘package:stats’:

    filter, lag

The following objects are masked from ‘package:base’:

    intersect, setdiff, setequal, union

[?25h[?25hLoading required package: StanHeaders
Loading required package: ggplot2
rstan (Version 2.21.7, GitRev: 2e1f913d3ca3)
For execution on a local, multicore CPU with excess RAM we recommend calling
options(mc.cores = parallel::detectCores()).
To avoid recompilation of unchanged Stan programs, we recommend calling
rstan_options(auto_write = TRUE)
[?25h
Attaching package: ‘gridExtra’

The following object is masked from ‘package:dplyr’:

    combine

[?25h[?25h[?25h[?25h
Attaching package: ‘coda’

The following object is masked from ‘package:rstan’:

    traceplot

[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[1] "Starting R-VGA..."
Error: object 'tf' not found
Execution halted
[?25h]0;babv971@niasra-node3:~/R-VGAL/5_Poisson[?2004h[babv971@niasra-node3 5_Poisson]$ Rscript poisson_mm_main.R[4Pca[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[4@Rscrip[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C
[?2004l2023-11-20 16:48:55.086830: I tensorflow/core/platform/cpu_feature_guard.cc:182] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
2023-11-20 16:48:57.737335: W tensorflow/compiler/tf2tensorrt/utils/py_utils.cc:38] TF-TRT Warning: Could not find TensorRT
2023-11-20 16:49:03.098579: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1639] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8192 MB memory:  -> device: 0, name: NVIDIA GeForce GTX TITAN, pci bus id: 0000:83:00.0, compute capability: 3.5
[1] "1 Physical GPUs,1 Logical GPUs"
[?25h
Attaching package: ‘dplyr’

The following objects are masked from ‘package:stats’:

    filter, lag

The following objects are masked from ‘package:base’:

    intersect, setdiff, setequal, union

[?25h[?25hLoading required package: StanHeaders
Loading required package: ggplot2
rstan (Version 2.21.7, GitRev: 2e1f913d3ca3)
For execution on a local, multicore CPU with excess RAM we recommend calling
options(mc.cores = parallel::detectCores()).
To avoid recompilation of unchanged Stan programs, we recommend calling
rstan_options(auto_write = TRUE)
[?25h
Attaching package: ‘gridExtra’

The following object is masked from ‘package:dplyr’:

    combine

[?25h[?25h[?25h[?25h
Attaching package: ‘coda’

The following object is masked from ‘package:rstan’:

    traceplot

[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[1] "Starting R-VGA..."
2023-11-20 16:49:05.340345: I tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:753] failed to allocate 8.00GiB (8589934592 bytes) from device: CUDA_ERROR_OUT_OF_MEMORY: out of memory
2023-11-20 16:49:05.346853: I tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:753] failed to allocate 7.20GiB (7730940928 bytes) from device: CUDA_ERROR_OUT_OF_MEMORY: out of memory
2023-11-20 16:49:05.353204: I tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:753] failed to allocate 6.48GiB (6957846528 bytes) from device: CUDA_ERROR_OUT_OF_MEMORY: out of memory
2023-11-20 16:49:05.359756: I tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:753] failed to allocate 5.83GiB (6262061568 bytes) from device: CUDA_ERROR_OUT_OF_MEMORY: out of memory
2023-11-20 16:49:05.366655: I tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:753] failed to allocate 5.25GiB (5635855360 bytes) from device: CUDA_ERROR_OUT_OF_MEMORY: out of memory
2023-11-20 16:49:05.374198: I tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:753] failed to allocate 4.72GiB (5072269824 bytes) from device: CUDA_ERROR_OUT_OF_MEMORY: out of memory
2023-11-20 16:49:05.380636: I tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:753] failed to allocate 4.25GiB (4565042688 bytes) from device: CUDA_ERROR_OUT_OF_MEMORY: out of memory
2023-11-20 16:49:05.386949: I tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:753] failed to allocate 3.83GiB (4108538368 bytes) from device: CUDA_ERROR_OUT_OF_MEMORY: out of memory
2023-11-20 16:49:05.393260: I tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:753] failed to allocate 3.44GiB (3697684480 bytes) from device: CUDA_ERROR_OUT_OF_MEMORY: out of memory
2023-11-20 16:49:05.399639: I tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:753] failed to allocate 3.10GiB (3327916032 bytes) from device: CUDA_ERROR_OUT_OF_MEMORY: out of memory
2023-11-20 16:49:05.406376: I tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:753] failed to allocate 2.79GiB (2995124224 bytes) from device: CUDA_ERROR_OUT_OF_MEMORY: out of memory
2023-11-20 16:49:05.413426: I tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:753] failed to allocate 2.51GiB (2695611648 bytes) from device: CUDA_ERROR_OUT_OF_MEMORY: out of memory
2023-11-20 16:49:05.420932: I tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:753] failed to allocate 2.26GiB (2426050304 bytes) from device: CUDA_ERROR_OUT_OF_MEMORY: out of memory
2023-11-20 16:49:05.427258: I tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:753] failed to allocate 2.03GiB (2183445248 bytes) from device: CUDA_ERROR_OUT_OF_MEMORY: out of memory
2023-11-20 16:49:05.433925: I tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:753] failed to allocate 1.83GiB (1965100800 bytes) from device: CUDA_ERROR_OUT_OF_MEMORY: out of memory
2023-11-20 16:49:05.441021: I tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:753] failed to allocate 1.65GiB (1768590848 bytes) from device: CUDA_ERROR_OUT_OF_MEMORY: out of memory
2023-11-20 16:49:05.447449: I tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:753] failed to allocate 1.48GiB (1591731712 bytes) from device: CUDA_ERROR_OUT_OF_MEMORY: out of memory
2023-11-20 16:49:06.346378: I tensorflow/core/util/cuda_solvers.cc:179] Creating GpuSolver handles for stream 0x55eb74b13b70
2023-11-20 16:49:06.790932: F tensorflow/core/util/cuda_solvers.cc:114] Check failed: cusolverDnCreate(&cusolver_dn_handle) == CUSOLVER_STATUS_SUCCESS Failed to create cuSolverDN instance.
Aborted (core dumped)
]0;babv971@niasra-node3:~/R-VGAL/5_Poisson[?2004h[babv971@niasra-node3 5_Poisson]$ 
[?2004l]0;babv971@niasra-node3:~/R-VGAL/5_Poisson[?2004h[babv971@niasra-node3 5_Poisson]$ 
[?2004l]0;babv971@niasra-node3:~/R-VGAL/5_Poisson[?2004h[babv971@niasra-node3 5_Poisson]$ Rscript poisson_mm_main.R[4Pca[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[4@Rscrip[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C
[?2004l2023-11-20 16:49:34.830417: I tensorflow/core/platform/cpu_feature_guard.cc:182] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
2023-11-20 16:49:35.871819: W tensorflow/compiler/tf2tensorrt/utils/py_utils.cc:38] TF-TRT Warning: Could not find TensorRT
2023-11-20 16:49:38.547152: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1639] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 4096 MB memory:  -> device: 0, name: NVIDIA GeForce GTX TITAN, pci bus id: 0000:83:00.0, compute capability: 3.5
[1] "1 Physical GPUs,1 Logical GPUs"
[?25h
Attaching package: ‘dplyr’

The following objects are masked from ‘package:stats’:

    filter, lag

The following objects are masked from ‘package:base’:

    intersect, setdiff, setequal, union

[?25h[?25hLoading required package: StanHeaders
Loading required package: ggplot2
rstan (Version 2.21.7, GitRev: 2e1f913d3ca3)
For execution on a local, multicore CPU with excess RAM we recommend calling
options(mc.cores = parallel::detectCores()).
To avoid recompilation of unchanged Stan programs, we recommend calling
rstan_options(auto_write = TRUE)
[?25h
Attaching package: ‘gridExtra’

The following object is masked from ‘package:dplyr’:

    combine

[?25h[?25h[?25h[?25h
Attaching package: ‘coda’

The following object is masked from ‘package:rstan’:

    traceplot

[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[1] "Starting R-VGA..."
2023-11-20 16:49:40.984586: I tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:753] failed to allocate 4.00GiB (4294967296 bytes) from device: CUDA_ERROR_OUT_OF_MEMORY: out of memory
2023-11-20 16:49:40.991028: I tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:753] failed to allocate 3.60GiB (3865470464 bytes) from device: CUDA_ERROR_OUT_OF_MEMORY: out of memory
2023-11-20 16:49:40.997459: I tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:753] failed to allocate 3.24GiB (3478923264 bytes) from device: CUDA_ERROR_OUT_OF_MEMORY: out of memory
2023-11-20 16:49:41.003923: I tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:753] failed to allocate 2.92GiB (3131030784 bytes) from device: CUDA_ERROR_OUT_OF_MEMORY: out of memory
2023-11-20 16:49:41.010853: I tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:753] failed to allocate 2.62GiB (2817927680 bytes) from device: CUDA_ERROR_OUT_OF_MEMORY: out of memory
2023-11-20 16:49:41.018216: I tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:753] failed to allocate 2.36GiB (2536134912 bytes) from device: CUDA_ERROR_OUT_OF_MEMORY: out of memory
2023-11-20 16:49:41.024714: I tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:753] failed to allocate 2.12GiB (2282521344 bytes) from device: CUDA_ERROR_OUT_OF_MEMORY: out of memory
2023-11-20 16:49:41.031280: I tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:753] failed to allocate 1.91GiB (205426918ailed to allocate 3.60GiB (3865470464 bytes) from device: CUDA_ERROR_OUT_OF_MEMORY: out of memory
2023-11-20 16:49:40.997459: I tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:753] failed to allocate 3.24GiB (3478923264 bytes) from device: CUDA_ERROR_OUT_OF_MEMORY: out of memory
2023-11-20 16:49:41.003923: I tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:753] failed to allocate 2.92GiB (3131030784 bytes) from device: CUDA_ERROR_OUT_OF_MEMORY: out of memory
2023-11-20 16:49:41.010853: I tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:753] failed to allocate 2.62GiB (2817927680 bytes) from device: CUDA_ERROR_OUT_OF_MEMORY: out of memory
2023-11-20 16:49:41.018216: I tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:753] failed to allocate 2.36GiB (2536134912 bytes) from device: CUDA_ERROR_OUT_OF_MEMORY: out of memory
2023-11-20 16:49:41.024714: I tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:753] failed to allocate 2.12GiB (2282521344 bytes) from device: CUDA_ERROR_OUT_OF_MEMORY: out of memory
2023-11-20 16:49:41.031280: I tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:753] failed to allocate 1.91GiB (2054269184 bytes) from device: CUDA_ERROR_OUT_OF_MEMORY: out of memory
2023-11-20 16:49:41.038323: I tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:753] failed to allocate 1.72GiB (1848842240 bytes) from device: CUDA_ERROR_OUT_OF_MEMORY: out of memory
2023-11-20 16:49:41.045887: I tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:753] failed to allocate 1.55GiB (1663958016 bytes) from device: CUDA_ERROR_OUT_OF_MEMORY: out of memory
2023-11-20 16:49:41.973667: I tensorflow/core/util/cuda_solvers.cc:179] Creating GpuSolver handles for stream 0x55d1bbb59200
2023-11-20 16:49:42.089128: F tensorflow/core/util/cuda_solvers.cc:114] Check failed: cusolverDnCreate(&cusolver_dn_handle) == CUSOLVER_STATUS_SUCCESS Failed to create cuSolverDN instance.
Aborted (core dumped)
]0;babv971@niasra-node3:~/R-VGAL/5_Poisson[?2004h[babv971@niasra-node3 5_Poisson]$ 
[?2004l]0;babv971@niasra-node3:~/R-VGAL/5_Poisson[?2004h[babv971@niasra-node3 5_Poisson]$ 
[?2004l]0;babv971@niasra-node3:~/R-VGAL/5_Poisson[?2004h[babv971@niasra-node3 5_Poisson]$ niasra[1Piasra[1Pasra[1Psra[1Pra[1Pa[Knvidia-smi
[?2004lMon Nov 20 16:49:59 2023       
+-----------------------------------------------------------------------------+
| NVIDIA-SMI 470.129.06   Driver Version: 470.129.06   CUDA Version: 11.4     |
|-------------------------------+----------------------+----------------------+
| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
|                               |                      |               MIG M. |
|===============================+======================+======================|
|   0  NVIDIA GeForce ...  Off  | 00000000:83:00.0 Off |                  N/A |
| 31%   43C    P0    77W / 250W |   4429MiB /  6083MiB |      0%      Default |
|                               |                      |                  N/A |
+-------------------------------+----------------------+----------------------+
                                                                               
+-----------------------------------------------------------------------------+
| Processes:                                                                  |
|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |
|        ID   ID                                                   Usage      |
|=============================================================================|
|    0   N/A  N/A   2459938      C   ...tudio-server/bin/rsession     4423MiB |
+-----------------------------------------------------------------------------+
]0;babv971@niasra-node3:~/R-VGAL/5_Poisson[?2004h[babv971@niasra-node3 5_Poisson]$ kill -9 2459938
[?2004l]0;babv971@niasra-node3:~/R-VGAL/5_Poisson[?2004h[babv971@niasra-node3 5_Poisson]$ ps [K[K[Kkill -9 2459938[5Pnvidia-smi
[?2004lMon Nov 20 16:50:12 2023       
+-----------------------------------------------------------------------------+
| NVIDIA-SMI 470.129.06   Driver Version: 470.129.06   CUDA Version: 11.4     |
|-------------------------------+----------------------+----------------------+
| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
|                               |                      |               MIG M. |
|===============================+======================+======================|
|   0  NVIDIA GeForce ...  Off  | 00000000:83:00.0 Off |                  N/A |
| 31%   44C    P0    77W / 250W |      1MiB /  6083MiB |      0%      Default |
|                               |                      |                  N/A |
+-------------------------------+----------------------+----------------------+
                                                                               
+-----------------------------------------------------------------------------+
| Processes:                                                                  |
|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |
|        ID   ID                                                   Usage      |
|=============================================================================|
|  No running processes found                                                 |
+-----------------------------------------------------------------------------+
]0;babv971@niasra-node3:~/R-VGAL/5_Poisson[?2004h[babv971@niasra-node3 5_Poisson]$ nvidia-smikill -9 2459938[5Pnvidia-smiRscript poisson_mm_main.R
[?2004l2023-11-20 16:50:20.205679: I tensorflow/core/platform/cpu_feature_guard.cc:182] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
2023-11-20 16:50:21.664349: W tensorflow/compiler/tf2tensorrt/utils/py_utils.cc:38] TF-TRT Warning: Could not find TensorRT
2023-11-20 16:50:25.288572: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1639] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 4096 MB memory:  -> device: 0, name: NVIDIA GeForce GTX TITAN, pci bus id: 0000:83:00.0, compute capability: 3.5
[1] "1 Physical GPUs,1 Logical GPUs"
[?25h
Attaching package: ‘dplyr’

The following objects are masked from ‘package:stats’:

    filter, lag

The following objects are masked from ‘package:base’:

    intersect, setdiff, setequal, union

[?25h[?25hLoading required package: StanHeaders
Loading required package: ggplot2
rstan (Version 2.21.7, GitRev: 2e1f913d3ca3)
For execution on a local, multicore CPU with excess RAM we recommend calling
options(mc.cores = parallel::detectCores()).
To avoid recompilation of unchanged Stan programs, we recommend calling
rstan_options(auto_write = TRUE)
[?25h
Attaching package: ‘gridExtra’

The following object is masked from ‘package:dplyr’:

    combine

[?25h[?25h[?25h[?25h
Attaching package: ‘coda’

The following object is masked from ‘package:rstan’:

    traceplot

[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[?25h[1] "Starting R-VGA..."
2023-11-20 16:50:28.546130: I tensorflow/core/util/cuda_solvers.cc:179] Creating GpuSolver handles for stream 0x55708976dc60
Error in compute_grad_hessian(y_i_tf, X_i_tf, Z_i_tf, alpha_all_tf, theta_tf,  : 
  could not find function "compute_grad_hessian"
Calls: run_rvgal
Execution ha